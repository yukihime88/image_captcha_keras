name: CAPTCHA Solver Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test CAPTCHA Solver
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify Python version
      run: python --version

    - name: Verify TensorFlow installation
      run: python -c "import tensorflow as tf; print('TensorFlow version:', tf.__version__)"

    - name: Test data loading
      run: |
        python -c "
        import os
        import cv2
        import numpy as np
        from train_captcha_solver import load_data

        # Test loading sample data
        X, y_list = load_data('Samples/')
        if X is not None:
            print(f'Successfully loaded {X.shape[0]} samples')
            print(f'Image shape: {X.shape}')
            print(f'Label structure: {len(y_list)} output heads')
        else:
            print('Failed to load data')
        "

    - name: Test model creation
      run: |
        python -c "
        from train_captcha_solver import create_cnn_model

        # Test creating model
        model = create_cnn_model(200, 100, 10, 6)
        print('Model created successfully')
        print('Model summary:')
        model.summary()
        "

    - name: Test sample prediction
      run: |
        python -c "
        import os
        import tensorflow as tf
        from train_captcha_solver import solve_captcha

        # Test with existing model if available
        if os.path.exists('best_captcha_solver_model.keras'):
            model = tf.keras.models.load_model('best_captcha_solver_model.keras')
            print('Model loaded successfully')

            # Test prediction on sample image
            if os.path.exists('gambar.jpg'):
                result = solve_captcha('gambar.jpg', model)
                print(f'Prediction result: {result}')
            else:
                print('Sample image not found')
        else:
            print('Trained model not found, skipping prediction test')
        "

    - name: Run basic tests
      run: |
        python -c "
        # Test basic functionality
        import sys
        import os

        # Check if required files exist
        required_files = ['train_captcha_solver.py', 'requirements.txt']
        missing_files = [f for f in required_files if not os.path.exists(f)]

        if missing_files:
            print(f'Missing required files: {missing_files}')
            sys.exit(1)
        else:
            print('All required files present')

        # Check if sample directory exists
        if os.path.exists('Samples'):
            sample_count = len([f for f in os.listdir('Samples') if f.endswith(('.jpg', '.png', '.jpeg'))])
            print(f'Found {sample_count} sample images')
        else:
            print('Sample directory not found')

        print('Basic tests completed successfully')
        "
